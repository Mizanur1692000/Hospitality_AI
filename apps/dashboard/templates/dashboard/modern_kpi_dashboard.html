{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modern KPI Dashboard - Restaurant Consulting</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{% static 'dashboard/css/modern-glass.css' %}">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
            glass: { bg: 'rgba(255, 255, 255, 0.1)', border: 'rgba(255, 255, 255, 0.2)' }
          }
        }
      }
    }
  </script>
  <style>
    /* Enhanced Modern KPI Dashboard Styles */
    .glass-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 1.25rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .glass-card:hover::before {
      opacity: 1;
    }
    .glass-card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 
        0 25px 50px rgba(102, 126, 234, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    .metric-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 10px currentColor;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .chart-container { 
      position: relative; 
      height: 300px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 1rem;
      padding: 1rem;
    }
    .sparkline-container { height: 40px; }
    
    /* Enhanced Status Badges */
    .status-badge {
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .status-badge:hover {
      transform: translateY(-2px);
    }
    
    /* Enhanced Select & Buttons */
    .header-select {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.75rem;
      padding: 0.625rem 1rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .header-select:hover, .header-select:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(102, 126, 234, 0.5);
      outline: none;
    }
    
    .refresh-btn {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 0.75rem;
      padding: 0.625rem 1.25rem;
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .refresh-btn:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    .refresh-btn svg {
      transition: transform 0.3s ease;
    }
    .refresh-btn:hover svg {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Animated Background -->
  <div class="animated-bg"></div>
  <div class="floating-orbs">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <!-- Header -->
  <header class="glass-header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-circle">C</div>
        <div class="brand-text">
          <div class="company-name">Curated Restaurant Consulting</div>
          <div class="company-tagline">Driven by Data. Crafted for Excellence.</div>
        </div>
      </div>
      <div class="header-actions">
        <select id="date-range" class="bg-white/10 backdrop-blur border border-white/20 rounded-lg px-4 py-2 text-white cursor-pointer">
          <option value="today">Today</option>
          <option value="week" selected>This Week</option>
          <option value="month">This Month</option>
          <option value="quarter">This Quarter</option>
        </select>
        <button onclick="refreshData()" class="bg-white/10 backdrop-blur border border-white/20 rounded-lg px-4 py-2 text-white hover:bg-white/20 transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Refresh
        </button>
        <a href="/dashboard/" class="back-button">← Dashboard</a>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div class="glass-interface p-8">
      <!-- Page Title -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Advanced KPI Dashboard</h1>
        <p class="text-white/60">Real-time analytics and performance monitoring</p>
      </div>

      <!-- Status Bar -->
      <div class="flex flex-wrap gap-4 mb-8">
        <div class="flex items-center gap-2 bg-green-500/20 rounded-full px-4 py-2">
          <div class="metric-indicator bg-green-500"></div>
          <span class="text-green-400 text-sm font-medium">5 KPIs Healthy</span>
        </div>
        <div class="flex items-center gap-2 bg-yellow-500/20 rounded-full px-4 py-2">
          <div class="metric-indicator bg-yellow-500"></div>
          <span class="text-yellow-400 text-sm font-medium">2 Need Attention</span>
        </div>
        <div class="flex items-center gap-2 bg-red-500/20 rounded-full px-4 py-2">
          <div class="metric-indicator bg-red-500"></div>
          <span class="text-red-400 text-sm font-medium">1 Critical</span>
        </div>
        <div class="ml-auto text-white/60 text-sm">Last updated: <span id="last-update">Just now</span></div>
      </div>

      <!-- Primary Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Revenue -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-white/60 text-sm uppercase tracking-wide">Total Revenue</p>
              <p class="text-3xl font-bold text-white mt-1" id="total-revenue">$0</p>
            </div>
            <div class="bg-green-500/20 rounded-full p-3">
              <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="trend-up text-sm font-medium">↑ 12.5%</span>
            <span class="text-white/40 text-sm">vs last period</span>
          </div>
          <div class="sparkline-container mt-4"><canvas id="revenue-sparkline"></canvas></div>
        </div>

        <!-- Labor Cost -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-white/60 text-sm uppercase tracking-wide">Labor Cost</p>
              <p class="text-3xl font-bold text-white mt-1" id="labor-cost">0%</p>
            </div>
            <div class="bg-yellow-500/20 rounded-full p-3">
              <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="trend-down text-sm font-medium">↑ 2.3%</span>
            <span class="text-white/40 text-sm">above target</span>
          </div>
          <div class="sparkline-container mt-4"><canvas id="labor-sparkline"></canvas></div>
        </div>

        <!-- Food Cost -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-white/60 text-sm uppercase tracking-wide">Food Cost</p>
              <p class="text-3xl font-bold text-white mt-1" id="food-cost">0%</p>
            </div>
            <div class="bg-green-500/20 rounded-full p-3">
              <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="trend-up text-sm font-medium">↓ 1.8%</span>
            <span class="text-white/40 text-sm">below target</span>
          </div>
          <div class="sparkline-container mt-4"><canvas id="food-sparkline"></canvas></div>
        </div>

        <!-- Prime Cost -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-white/60 text-sm uppercase tracking-wide">Prime Cost</p>
              <p class="text-3xl font-bold text-white mt-1" id="prime-cost">0%</p>
            </div>
            <div class="bg-primary-500/20 rounded-full p-3">
              <svg class="w-6 h-6 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-white/60 text-sm font-medium">On target</span>
          </div>
          <div class="sparkline-container mt-4"><canvas id="prime-sparkline"></canvas></div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Trend -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-white mb-4">Revenue Trend</h3>
          <div class="chart-container"><canvas id="revenue-chart"></canvas></div>
        </div>

        <!-- Cost Breakdown -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-white mb-4">Cost Breakdown</h3>
          <div class="chart-container"><canvas id="cost-chart"></canvas></div>
        </div>
      </div>

      <!-- Secondary Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Daily Sales -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-white mb-4">Daily Sales</h3>
          <div class="chart-container" style="height: 250px;"><canvas id="daily-chart"></canvas></div>
        </div>

        <!-- Performance Radar -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-white mb-4">Performance Score</h3>
          <div class="chart-container" style="height: 250px;"><canvas id="radar-chart"></canvas></div>
        </div>

        <!-- Top Items -->
        <div class="glass-card p-6">
          <h3 class="text-lg font-semibold text-white mb-4">Top Performers</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white">Grilled Salmon</span>
              <span class="text-green-400 font-semibold">$4,250</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white">Ribeye Steak</span>
              <span class="text-green-400 font-semibold">$3,890</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white">Lobster Tail</span>
              <span class="text-green-400 font-semibold">$3,420</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white">Truffle Pasta</span>
              <span class="text-green-400 font-semibold">$2,980</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <section class="chat-section">
        <div class="chat-header">
          <h3 class="chat-title">AI Insights</h3>
          <button class="clear-chat" onclick="clearChat()">Clear</button>
        </div>

        <div class="messages-area" id="messages-area">
          <div class="message assistant">
            <div class="message-bubble">I've analyzed your dashboard data. Your revenue is trending up 12.5%, but labor costs are 2.3% above target. Would you like me to suggest optimization strategies?</div>
            <div class="message-time">Just now</div>
          </div>
        </div>

        <div class="input-section">
          <div class="input-container">
            <textarea id="chat-input" class="chat-input" placeholder="Ask about your KPIs..." rows="1"></textarea>
            <button class="send-button" onclick="sendMessage()">
              <span>Ask</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize data
      document.getElementById('total-revenue').textContent = '$148,250';
      document.getElementById('labor-cost').textContent = '32.4%';
      document.getElementById('food-cost').textContent = '28.2%';
      document.getElementById('prime-cost').textContent = '60.6%';

      const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: 'rgba(255,255,255,0.7)' } } },
        scales: {
          x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        }
      };

      // Sparklines
      const sparklineOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 } } };
      
      ['revenue', 'labor', 'food', 'prime'].forEach((id, i) => {
        const data = [
          [28, 32, 30, 35, 38, 42, 40],
          [30, 31, 32, 33, 32, 33, 32],
          [29, 28, 30, 28, 27, 28, 28],
          [59, 59, 62, 61, 59, 61, 60]
        ][i];
        new Chart(document.getElementById(`${id}-sparkline`), {
          type: 'line',
          data: { labels: data, datasets: [{ data, borderColor: '#667eea', borderWidth: 2, fill: false, tension: 0.4 }] },
          options: sparklineOptions
        });
      });

      // Revenue Chart
      new Chart(document.getElementById('revenue-chart'), {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'This Week',
            data: [18500, 19200, 21500, 22800, 26400, 28500, 24800],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4
          }, {
            label: 'Last Week',
            data: [16200, 17800, 19200, 20100, 23500, 25200, 22400],
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: chartDefaults
      });

      // Cost Chart
      new Chart(document.getElementById('cost-chart'), {
        type: 'doughnut',
        data: {
          labels: ['Labor', 'Food', 'Beverage', 'Overhead', 'Profit'],
          datasets: [{
            data: [32.4, 28.2, 8.5, 15.9, 15],
            backgroundColor: ['#667eea', '#764ba2', '#f59e0b', '#10b981', '#22c55e'],
            borderWidth: 0
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)' } } } }
      });

      // Daily Chart
      new Chart(document.getElementById('daily-chart'), {
        type: 'bar',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Sales',
            data: [4200, 3800, 4500, 4800, 5600, 6200, 5400],
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderRadius: 8
          }]
        },
        options: { ...chartDefaults, plugins: { legend: { display: false } } }
      });

      // Radar Chart
      new Chart(document.getElementById('radar-chart'), {
        type: 'radar',
        data: {
          labels: ['Revenue', 'Labor', 'Food', 'Service', 'Quality', 'Efficiency'],
          datasets: [{
            label: 'Current',
            data: [88, 72, 85, 90, 82, 78],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.2)'
          }, {
            label: 'Target',
            data: [85, 80, 80, 85, 85, 85],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: 'rgba(255,255,255,0.7)' } } } }
      });

      // Chat functionality
      const messagesArea = document.getElementById('messages-area');
      const chatInput = document.getElementById('chat-input');

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      }
      const CSRF_TOKEN = getCookie('csrftoken');

      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      window.sendMessage = async function() {
        const message = chatInput.value.trim();
        if (!message) return;
        addMessage(message, true);
        chatInput.value = '';

        try {
          const response = await fetch('/chat/api/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': CSRF_TOKEN },
            body: `message=${encodeURIComponent(message)}&context=kpi_dashboard`
          });
          const data = await response.json();
          addMessage(data.response || 'No response', false);
        } catch (error) {
          addMessage(`❌ Error: ${error.message}`, false);
        }
      };

      function addMessage(content, isUser) {
        const div = document.createElement('div');
        div.className = `message ${isUser ? 'user' : 'assistant'}`;
        div.innerHTML = `<div class="message-bubble">${content}</div><div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>`;
        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      window.clearChat = function() {
        messagesArea.innerHTML = '<div class="message assistant"><div class="message-bubble">I\'ve analyzed your dashboard data. Your revenue is trending up 12.5%, but labor costs are 2.3% above target. Would you like me to suggest optimization strategies?</div><div class="message-time">Just now</div></div>';
      };

      window.refreshData = function() {
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
      };
    });
  </script>
</body>
</html>
