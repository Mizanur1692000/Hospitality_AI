{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Strategic Planning - Restaurant Consulting</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'dashboard/css/modern-glass.css' %}">
  <style>
    /* Enhanced Strategic Planning Styles */
    .planning-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }
    @media (max-width: 992px) { .planning-grid { grid-template-columns: 1fr; } }
    
    .planning-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(102, 126, 234, 0.12);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    .planning-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
      background-size: 200% 100%;
      animation: gradientShift 3s ease infinite;
    }
    .planning-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(102, 126, 234, 0.06) 0%, transparent 60%);
      pointer-events: none;
    }
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .planning-card:hover {
      transform: translateY(-8px) scale(1.01);
      box-shadow: 
        0 25px 50px rgba(102, 126, 234, 0.2),
        0 0 0 1px rgba(102, 126, 234, 0.1);
    }
    
    .card-header { display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
    .card-icon {
      width: 52px;
      height: 52px;
      background: var(--primary-gradient);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.35);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .planning-card:hover .card-icon {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.45);
    }
    .card-icon svg { width: 26px; height: 26px; color: white; }
    .card-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
    .card-subtitle { font-size: 0.875rem; color: var(--text-secondary); }
    
    .swot-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }
    .swot-item {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .swot-item::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .swot-item:hover::before {
      opacity: 0.3;
    }
    .swot-item.strengths { 
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.06) 100%);
      border-left: 4px solid #10b981;
      box-shadow: 0 2px 10px rgba(16, 185, 129, 0.1);
    }
    .swot-item.weaknesses { 
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.12) 0%, rgba(239, 68, 68, 0.06) 100%);
      border-left: 4px solid #ef4444;
      box-shadow: 0 2px 10px rgba(239, 68, 68, 0.1);
    }
    .swot-item.opportunities { 
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(102, 126, 234, 0.06) 100%);
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }
    .swot-item.threats { 
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.06) 100%);
      border-left: 4px solid #f59e0b;
      box-shadow: 0 2px 10px rgba(245, 158, 11, 0.1);
    }
    .swot-label { font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9rem; }
    .swot-list { list-style: none; padding: 0; margin: 0; color: var(--text-secondary); font-size: 0.8rem; }
    .swot-list li { padding: 0.35rem 0; position: relative; padding-left: 1rem; }
    .swot-list li::before { content: '‚Ä¢'; position: absolute; left: 0; color: inherit; opacity: 0.5; }
    
    .goal-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-lg);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 250, 252, 0.9) 100%);
      border: 1px solid rgba(102, 126, 234, 0.1);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-sm);
      transition: all 0.3s ease;
    }
    .goal-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.2);
    }
    .goal-checkbox {
      width: 26px;
      height: 26px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .goal-checkbox:hover {
      border-color: #667eea;
      transform: scale(1.1);
    }
    .goal-checkbox.completed {
      background: var(--primary-gradient);
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .goal-checkbox.completed::after {
      content: '‚úì';
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }
    .goal-text { flex: 1; color: var(--text-primary); font-size: 0.9rem; font-weight: 500; }
    .goal-priority {
      font-size: 0.75rem;
      padding: 0.35rem 0.75rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .goal-priority.high { background: rgba(239, 68, 68, 0.15); color: #dc2626; border: 1px solid rgba(239, 68, 68, 0.3); }
    .goal-priority.medium { background: rgba(245, 158, 11, 0.15); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.3); }
    .goal-priority.low { background: rgba(16, 185, 129, 0.15); color: #059669; border: 1px solid rgba(16, 185, 129, 0.3); }
    
    .timeline-item {
      display: flex;
      gap: var(--spacing-md);
      padding: var(--spacing-lg) 0;
      border-left: 2px solid rgba(102, 126, 234, 0.2);
      padding-left: var(--spacing-xl);
      position: relative;
      transition: all 0.3s ease;
    }
    .timeline-item:hover {
      padding-left: calc(var(--spacing-xl) + 5px);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -7px;
      top: 1.5rem;
      width: 12px;
      height: 12px;
      background: var(--primary-gradient);
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
    }
    .timeline-item:hover::before {
      transform: scale(1.3);
      box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.3);
    }
    .timeline-date { 
      font-size: 0.75rem; 
      color: var(--text-secondary); 
      min-width: 70px;
      font-weight: 600;
      background: rgba(102, 126, 234, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      text-align: center;
      height: fit-content;
    }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
    .timeline-desc { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.35rem; line-height: 1.5; }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid rgba(102, 126, 234, 0.08);
      transition: all 0.3s ease;
    }
    .metric-row:hover {
      background: rgba(102, 126, 234, 0.03);
      padding-left: var(--spacing-sm);
      padding-right: var(--spacing-sm);
      border-radius: var(--radius-md);
    }
    .metric-row:last-child { border-bottom: none; }
    .metric-label { color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; }
    .metric-value { font-weight: 700; color: var(--text-primary); font-size: 1.1rem; }
    .metric-bar {
      flex: 1;
      margin: 0 var(--spacing-lg);
      height: 8px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    .metric-progress {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: var(--radius-full);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    /* Core Task Card Enhancements */
    .core-task-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border: 1px solid rgba(102, 126, 234, 0.12);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      text-align: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    .core-task-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .core-task-card:hover::before {
      transform: scaleX(1);
    }
    .core-task-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.2);
    }
    .task-icon {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--spacing-md);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .core-task-card:hover .task-icon {
      transform: scale(1.15) rotate(5deg);
    }
    .task-title {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 1.15rem;
    }
    .task-features li::before {
      content: '‚úì';
      color: #10b981;
      font-weight: bold;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="animated-bg"></div>
  <div class="floating-orbs">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <!-- Header -->
  <header class="glass-header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-circle" aria-hidden="true">C</div>
        <div class="brand-text">
          <div class="company-name">Curated Restaurant Consulting</div>
          <div class="company-tagline">Driven by Data. Crafted for Excellence.</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="/dashboard/" class="back-button">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div class="glass-interface">
      <!-- Page Header -->
      <section class="page-header">
        <h1 class="page-title">Strategic Planning</h1>
        <p class="page-subtitle">Develop comprehensive business strategies with AI-powered insights and actionable roadmaps</p>

        <!-- Core Tasks Grid -->
        <div class="core-tasks-grid">
          <!-- SWOT Analysis -->
          <div class="core-task-card" onclick="swotAnalysis()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <rect x="4" y="4" width="14" height="14" rx="2" stroke="white" stroke-width="2"/>
                <rect x="22" y="4" width="14" height="14" rx="2" stroke="white" stroke-width="2"/>
                <rect x="4" y="22" width="14" height="14" rx="2" stroke="white" stroke-width="2"/>
                <rect x="22" y="22" width="14" height="14" rx="2" stroke="white" stroke-width="2"/>
              </svg>
            </div>
            <div class="task-title">SWOT Analysis</div>
            <div class="task-desc">Comprehensive business assessment</div>
            <ul class="task-features">
              <li>Strengths & weaknesses</li>
              <li>Market opportunities</li>
              <li>Threat mitigation</li>
            </ul>
          </div>

          <!-- Business Goals -->
          <div class="core-task-card" onclick="businessGoals()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <circle cx="20" cy="20" r="16" stroke="white" stroke-width="2"/>
                <circle cx="20" cy="20" r="10" stroke="white" stroke-width="2"/>
                <circle cx="20" cy="20" r="4" fill="white"/>
              </svg>
            </div>
            <div class="task-title">Business Goals</div>
            <div class="task-desc">Set and track strategic objectives</div>
            <ul class="task-features">
              <li>SMART goal setting</li>
              <li>Progress tracking</li>
              <li>Milestone planning</li>
            </ul>
          </div>

          <!-- Growth Strategy -->
          <div class="core-task-card" onclick="growthStrategy()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <path d="M4 36L14 26L22 30L36 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <path d="M28 12H36V20" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="task-title">Growth Strategy</div>
            <div class="task-desc">Scale your business effectively</div>
            <ul class="task-features">
              <li>Expansion planning</li>
              <li>Market analysis</li>
              <li>Revenue projections</li>
            </ul>
          </div>

          <!-- Best Way (Playbook) -->
          <div class="core-task-card" onclick="bestWay()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <path d="M6 10h20M6 18h20M6 26h12" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="task-title">Best Way</div>
            <div class="task-desc">Step-by-step playbook</div>
            <ul class="task-features">
              <li>Objectives first</li>
              <li>SWOT + KPIs</li>
              <li>Budget + timeline</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Planning Cards Grid -->
      <div class="planning-grid">
        <!-- SWOT Analysis Card -->
        <div class="planning-card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            </div>
            <div>
              <div class="card-title">SWOT Analysis</div>
              <div class="card-subtitle">Last updated: Today</div>
            </div>
          </div>
          <div class="swot-grid">
            <div class="swot-item strengths">
              <div class="swot-label">Strengths</div>
              <ul class="swot-list">
                <li>‚Ä¢ Prime location</li>
                <li>‚Ä¢ Experienced chef</li>
                <li>‚Ä¢ Strong brand</li>
              </ul>
            </div>
            <div class="swot-item weaknesses">
              <div class="swot-label">Weaknesses</div>
              <ul class="swot-list">
                <li>‚Ä¢ High labor costs</li>
                <li>‚Ä¢ Limited seating</li>
                <li>‚Ä¢ No delivery</li>
              </ul>
            </div>
            <div class="swot-item opportunities">
              <div class="swot-label">Opportunities</div>
              <ul class="swot-list">
                <li>‚Ä¢ Catering market</li>
                <li>‚Ä¢ Online ordering</li>
                <li>‚Ä¢ Weekend brunch</li>
              </ul>
            </div>
            <div class="swot-item threats">
              <div class="swot-label">Threats</div>
              <ul class="swot-list">
                <li>‚Ä¢ New competitors</li>
                <li>‚Ä¢ Rising food costs</li>
                <li>‚Ä¢ Economic downturn</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Strategic Goals Card -->
        <div class="planning-card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            </div>
            <div>
              <div class="card-title">Strategic Goals</div>
              <div class="card-subtitle">Q4 2024 Objectives</div>
            </div>
          </div>
          <div class="goal-item">
            <div class="goal-checkbox completed"></div>
            <div class="goal-text">Launch online ordering platform</div>
            <span class="goal-priority high">High</span>
          </div>
          <div class="goal-item">
            <div class="goal-checkbox"></div>
            <div class="goal-text">Reduce food cost to 28%</div>
            <span class="goal-priority high">High</span>
          </div>
          <div class="goal-item">
            <div class="goal-checkbox"></div>
            <div class="goal-text">Implement new POS system</div>
            <span class="goal-priority medium">Medium</span>
          </div>
          <div class="goal-item">
            <div class="goal-checkbox"></div>
            <div class="goal-text">Start catering services</div>
            <span class="goal-priority medium">Medium</span>
          </div>
          <div class="goal-item">
            <div class="goal-checkbox"></div>
            <div class="goal-text">Rebrand social media presence</div>
            <span class="goal-priority low">Low</span>
          </div>
        </div>

        <!-- Timeline Card -->
        <div class="planning-card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <div class="card-title">Implementation Timeline</div>
              <div class="card-subtitle">Next 6 months</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-date">Oct 2024</div>
            <div class="timeline-content">
              <div class="timeline-title">Phase 1: Foundation</div>
              <div class="timeline-desc">Complete SWOT, set KPIs, finalize budget</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-date">Nov 2024</div>
            <div class="timeline-content">
              <div class="timeline-title">Phase 2: Technology</div>
              <div class="timeline-desc">POS upgrade, online ordering launch</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-date">Dec 2024</div>
            <div class="timeline-content">
              <div class="timeline-title">Phase 3: Marketing</div>
              <div class="timeline-desc">Holiday campaign, loyalty program</div>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-date">Jan 2025</div>
            <div class="timeline-content">
              <div class="timeline-title">Phase 4: Expansion</div>
              <div class="timeline-desc">Catering launch, brunch service</div>
            </div>
          </div>
        </div>

        <!-- KPI Targets Card -->
        <div class="planning-card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            </div>
            <div>
              <div class="card-title">KPI Targets</div>
              <div class="card-subtitle">Progress to goals</div>
            </div>
          </div>
          <div class="metric-row">
            <span class="metric-label">Revenue Growth</span>
            <div class="metric-bar"><div class="metric-progress" style="width: 75%;"></div></div>
            <span class="metric-value">75%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Food Cost</span>
            <div class="metric-bar"><div class="metric-progress" style="width: 90%;"></div></div>
            <span class="metric-value">90%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Labor Cost</span>
            <div class="metric-bar"><div class="metric-progress" style="width: 60%;"></div></div>
            <span class="metric-value">60%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Customer Satisfaction</span>
            <div class="metric-bar"><div class="metric-progress" style="width: 85%;"></div></div>
            <span class="metric-value">85%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Online Orders</span>
            <div class="metric-bar"><div class="metric-progress" style="width: 40%;"></div></div>
            <span class="metric-value">40%</span>
          </div>
        </div>
      </div>

      <!-- Best Way: Practical Playbook -->
      <div class="planning-card">
        <div class="card-header">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h10"/></svg>
          </div>
          <div>
            <div class="card-title">Best Way: Practical Playbook</div>
            <div class="card-subtitle">Proven sequence for strategic planning</div>
          </div>
        </div>
        <div>
          <ol style="margin:0; padding-left:1.25rem; color: var(--text-secondary);">
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Define Objectives</strong> ‚Äì 3-5 measurable goals (revenue, margin, growth).</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Audit + SWOT</strong> ‚Äì Assess strengths, weaknesses, opportunities, threats.</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Set KPIs</strong> ‚Äì Food%, Labor%, Prime%, RevPASH, satisfaction, conversion.</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Budget & Resources</strong> ‚Äì Allocate spend, staffing, marketing, tech.</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Timeline & Milestones</strong> ‚Äì Monthly phases with deliverables.</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Execute & Track</strong> ‚Äì Weekly reviews; adjust by KPI variance.</li>
            <li style="margin:0.4rem 0; color: var(--text-primary);"><strong>Review & Improve</strong> ‚Äì Post-mortem each phase; update plan.</li>
          </ol>
          <div style="margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 0.9rem;">
            Tip: Use Business Goals with $ inputs for budget and ROI; upload forecasting CSVs to ground targets.
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <section class="chat-section">
        <div class="chat-header">
          <h3 class="chat-title">Strategic Planning AI</h3>
          <button class="clear-chat" onclick="clearChat()">Clear Chat</button>
        </div>

        <div class="messages-area" id="messages-area">
          <div class="message assistant">
            <div class="message-bubble">Welcome to Strategic Planning! <strong>To get accurate analysis, please provide your data</strong>:<br><br>
              <strong>üìà Sales Forecasting:</strong><br>
              ‚Ä¢ Required: historical_sales, current_sales, growth_rate, seasonal_factor<br>
              ‚Ä¢ Optional: forecast_period, trend_strength, market_growth, confidence_level<br><br>
              <strong>üéØ Business Goals:</strong><br>
              ‚Ä¢ Required: revenue_target ($), budget_total ($), marketing_spend ($), target_roi (%)<br>
              ‚Ä¢ Optional: timeline_months, acquisition_cost ($), conversion_rate (%)<br><br>
              <strong>üöÄ Growth Strategy:</strong><br>
              ‚Ä¢ Required: market_size ($), market_share (%), competition_level (%), investment_budget ($)<br>
              ‚Ä¢ Optional: growth_potential (%), competitive_advantage, market_penetration (%), target_roi (%)<br><br>
              <strong>‚öôÔ∏è Operational Excellence:</strong><br>
              ‚Ä¢ Required: efficiency_score (%), process_time (minutes), quality_rating, customer_satisfaction (%)<br>
              ‚Ä¢ Optional: cost_per_unit ($), waste_percentage (%), productivity_score, industry_benchmark (%)<br><br>
              <strong>CSV Upload Guidance:</strong><br>
              ‚Ä¢ sales_forecasting.csv: historical_sales, current_sales, growth_rate, seasonal_factor, forecast_period<br>
              ‚Ä¢ business_goals.csv: revenue_target, budget_total, marketing_spend, target_roi, timeline_months<br>
              ‚Ä¢ growth_strategy.csv: market_size, market_share, competition_level, investment_budget, target_roi<br>
              ‚Ä¢ operational_excellence.csv: efficiency_score, process_time_minutes, quality_rating, customer_satisfaction<br><br>
              Click the quick action buttons above to see example prompts with sample data.</div>
            <div class="message-time">Just now</div>
          </div>
        </div>

        <div class="input-section">
          <div class="input-container">
            <textarea id="chat-input" class="chat-input" placeholder="Describe your strategic planning needs..." rows="1"></textarea>
            <input type="file" id="file-input" accept=".csv,.xlsx,.pdf" class="file-input"/>
            <button id="upload-button" class="upload-button" title="Upload planning documents">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L16,16H13.5V19H10.5V16H8L12,12Z"/>
              </svg>
            </button>
            <button id="send-button" class="send-button" onclick="sendMessage()">
              <span>Plan</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messagesArea = document.getElementById('messages-area');
      const chatInput = document.getElementById('chat-input');
      const fileInput = document.getElementById('file-input');
      const uploadButton = document.getElementById('upload-button');
      const goalCheckboxes = document.querySelectorAll('.goal-checkbox');

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      }
      const CSRF_TOKEN = getCookie('csrftoken');

      // Goal checkbox toggle
      goalCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('click', function() {
          this.classList.toggle('completed');
        });
      });

      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      uploadButton.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        addMessage(`üìÅ Uploading: ${file.name}`, true);

        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const text = String(reader.result || '');
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            if (lines.length < 2) {
              addMessage('‚ùå Error: File has no data rows', false);
              return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1).map(line => line.split(',').map(c => c.trim()));

            // Normalize headers to support variants like "market_size_total", "market size", "MarketSize"
            const normalizedHeaders = headers.map(h => h.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_'));

            const hasHeader = (name) => {
              const n = String(name).toLowerCase().replace(/[^a-z0-9]+/g, '_');
              return normalizedHeaders.some(h => h === n || h.startsWith(n) || h.includes(n));
            };

            // Index helper supports synonyms and suffixes (underscored and non-underscored)
            const idx = (name) => {
              const names = Array.isArray(name) ? name : [name];
              for (const nRaw of names) {
                const n = String(nRaw).toLowerCase().replace(/[^a-z0-9]+/g, '_');
                // exact match first
                let i = normalizedHeaders.indexOf(n);
                if (i >= 0) return i;
                // prefix match
                i = normalizedHeaders.findIndex(h => h.startsWith(n));
                if (i >= 0) return i;
                // contains match
                i = normalizedHeaders.findIndex(h => h.includes(n));
                if (i >= 0) return i;
              }
              return -1;
            };

            // Type detection (use normalized matching so suffixes like _total/_sum work)
            // Prefer Growth Strategy when market_* fields exist, otherwise Business Goals
            let type = 'General Strategic Planning';
            if (hasHeader('historical_sales') || hasHeader('current_sales') || hasHeader('growth_rate') || hasHeader('seasonal_factor') || hasHeader('forecast_period')) {
              type = 'Sales Forecasting';
            } else if (hasHeader('market_size') || hasHeader('market_share') || hasHeader('competition_level') || hasHeader('investment_budget')) {
              // Note: 'target_roi' is a shared metric used by Business Goals as well,
              // do not use it alone to classify as Growth Strategy.
              type = 'Growth Strategy';
            } else if (hasHeader('revenue_target') || hasHeader('budget_total') || hasHeader('marketing_spend') || hasHeader('target_roi') || hasHeader('timeline_months')) {
              type = 'Business Goals';
            } else if (hasHeader('efficiency_score') || hasHeader('process_time') || hasHeader('process_time_minutes') || hasHeader('quality_rating') || hasHeader('customer_satisfaction')) {
              type = 'Operational Excellence';
            }
            const isBlank = (v) => !v || String(v).trim() === '';
            const toNumber = (v) => {
              if (isBlank(v)) return NaN;
              const n = parseFloat(String(v).replace(/[^0-9.-]/g, ''));
              return isNaN(n) ? NaN : n;
            };
            const avg = (arr) => {
              const nums = arr.filter(x => typeof x === 'number' && !isNaN(x));
              if (!nums.length) return NaN;
              return nums.reduce((a,b) => a+b, 0) / nums.length;
            };
            const sum = (arr) => {
              const nums = arr.filter(x => typeof x === 'number' && !isNaN(x));
              if (!nums.length) return NaN;
              return nums.reduce((a,b) => a+b, 0);
            };

            // Build sanitized metrics by type (skip blanks/NaN)
            let prompt = '';
            if (type === 'Sales Forecasting') {
              const historical = rows.map(r => toNumber(r[idx(['historical_sales','historicalsales'])]));
              const current = rows.map(r => toNumber(r[idx(['current_sales','currentsales'])]));
              const growth = rows.map(r => toNumber(r[idx(['growth_rate','growthrate'])]));
              const seasonal = rows.map(r => toNumber(r[idx(['seasonal_factor','seasonalfactor'])]));
              const periodIdx = idx(['forecast_period','forecastperiod']);
              const periods = periodIdx >= 0 ? rows.map(r => toNumber(r[periodIdx])) : [];

              const historicalTotal = sum(historical);
              const currentTotal = sum(current);
              const avgGrowth = avg(growth);
              const avgSeasonal = avg(seasonal);
              const forecastPeriod = periods.find(p => !isNaN(p)) || 12;

              // Local quick summary for user feedback
              const nextMonthForecast = (isNaN(currentTotal) ? 0 : currentTotal) * (1 + ((isNaN(avgGrowth) ? 0 : avgGrowth) / 100)) * (isNaN(avgSeasonal) ? 1 : avgSeasonal);
              const summaryLines = [
                '<strong>Sales Forecast Summary</strong>',
                `Historical Sales (total): ${formatCurrency(isNaN(historicalTotal) ? 0 : historicalTotal)}`,
                `Current Sales (total): ${formatCurrency(isNaN(currentTotal) ? 0 : currentTotal)}`,
                `Avg Growth Rate: ${formatPercent(isNaN(avgGrowth) ? 0 : avgGrowth)}`,
                `Avg Seasonal Factor: ${(isNaN(avgSeasonal) ? 1 : avgSeasonal).toFixed(2)}`,
                `Forecast Period: ${forecastPeriod} months`,
                `Next Period Forecast (approx): ${formatCurrency(nextMonthForecast)}`
              ];
              addMessage(summaryLines.join('<br>'), false);

              // Natural-language prompt the backend expects (includes explicit analysis type)
              prompt = [
                'Analysis type: Sales Forecasting',
                'Forecast my sales based on the uploaded CSV.',
                `Historical sales: ${isNaN(historicalTotal) ? 0 : historicalTotal}`,
                `Current sales: ${isNaN(currentTotal) ? 0 : currentTotal}`,
                `Growth rate: ${isNaN(avgGrowth) ? 0 : avgGrowth}%`,
                `Seasonal factor: ${(isNaN(avgSeasonal) ? 1 : avgSeasonal).toFixed(2)}`,
                `Forecast period: ${forecastPeriod} months`
              ].join('\n');
            } else if (type === 'Business Goals') {
              const revenueTargets = rows.map(r => toNumber(r[idx('revenue_target')]));
              const budgets = rows.map(r => toNumber(r[idx('budget_total')]));
              const marketing = rows.map(r => toNumber(r[idx('marketing_spend')]));
              const rois = rows.map(r => toNumber(r[idx('target_roi')]));
              const timelineIdx = idx('timeline_months');
              const timelines = timelineIdx >= 0 ? rows.map(r => toNumber(r[timelineIdx])) : [];

              prompt = [
                'Analysis type: Business Goals',
                'Analyze Business Goals using sanitized metrics:',
                `revenue_target_total: ${isNaN(sum(revenueTargets)) ? 0 : sum(revenueTargets)}`,
                `budget_total_sum: ${isNaN(sum(budgets)) ? 0 : sum(budgets)}`,
                `marketing_spend_sum: ${isNaN(sum(marketing)) ? 0 : sum(marketing)}`,
                `average_target_roi_percent: ${isNaN(avg(rois)) ? 0 : avg(rois)}`,
                `timeline_months: ${timelines.find(t => !isNaN(t)) || 12}`
              ].join('\n');
            } else if (type === 'Growth Strategy') {
              const marketSize = rows.map(r => toNumber(r[idx('market_size')]));
              const marketShare = rows.map(r => toNumber(r[idx('market_share')]));
              const competition = rows.map(r => toNumber(r[idx('competition_level')]));
              const investBudget = rows.map(r => toNumber(r[idx('investment_budget')]));
              const rois = rows.map(r => toNumber(r[idx('target_roi')]));

              const marketSizeTotal = isNaN(sum(marketSize)) ? 0 : sum(marketSize);
              const avgShare = isNaN(avg(marketShare)) ? 0 : avg(marketShare);
              const avgCompetition = isNaN(avg(competition)) ? 0 : avg(competition);
              const investTotal = isNaN(sum(investBudget)) ? 0 : sum(investBudget);
              const avgRoi = isNaN(avg(rois)) ? 0 : avg(rois);

              // Local summary for quick feedback
              const gsSummary = [
                '<strong>Growth Strategy Summary</strong>',
                `Market Size (total): ${formatCurrency(marketSizeTotal)}`,
                `Market Share (avg): ${formatPercent(avgShare)}`,
                `Competition Level (avg): ${formatPercent(avgCompetition)}`,
                `Investment Budget (total): ${formatCurrency(investTotal)}`,
                `Target ROI (avg): ${formatPercent(avgRoi)}`
              ].join('<br>');
              addMessage(gsSummary, false);

              // Natural-language prompt for backend extraction (explicit analysis type)
              prompt = [
                'Analysis type: Growth Strategy',
                'Analyze growth strategy.',
                `Market size: ${marketSizeTotal}`,
                `Market share: ${avgShare}%`,
                `Competition level: ${avgCompetition}%`,
                `Investment budget: ${investTotal}`,
                `Target ROI: ${avgRoi}%`
              ].join('\n');
            } else if (type === 'Operational Excellence') {
              const efficiency = rows.map(r => toNumber(r[idx('efficiency_score')]));
              const processTime = rows.map(r => toNumber(r[idx('process_time_minutes')]));
              const qualityIdx = idx('quality_rating');
              const quality = qualityIdx >= 0 ? rows.map(r => toNumber(r[qualityIdx])) : [];
              const csat = rows.map(r => toNumber(r[idx('customer_satisfaction')]));

              const avgEff = isNaN(avg(efficiency)) ? 0 : avg(efficiency);
              const avgProc = isNaN(avg(processTime)) ? 0 : avg(processTime);
              const avgQual = isNaN(avg(quality)) ? 0 : avg(quality);
              const avgCsat = isNaN(avg(csat)) ? 0 : avg(csat);

              const opSummary = [
                '<strong>Operational Excellence Summary</strong>',
                `Efficiency Score (avg): ${formatPercent(avgEff)}`,
                `Process Time (avg): ${avgProc.toFixed(1)} minutes`,
                `Quality Rating (avg): ${avgQual.toFixed(2)}`,
                `Customer Satisfaction (avg): ${formatPercent(avgCsat)}`
              ].join('<br>');
              addMessage(opSummary, false);

              // Natural-language prompt for backend extraction (explicit analysis type)
              prompt = [
                'Analysis type: Operational Excellence',
                'Analyze operational excellence.',
                `Efficiency score: ${avgEff}%`,
                `Process time: ${avgProc} minutes`,
                `Quality rating: ${avgQual}`,
                `Customer satisfaction: ${avgCsat}%`
              ].join('\n');
            } else {
              prompt = `Analyze strategic planning. File: ${file.name}. Columns: ${headers.join(', ')}`;
            }

            const response = await fetch('/chat/api/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': CSRF_TOKEN },
              body: `message=${encodeURIComponent(prompt)}&context=strategic_planning`
            });
            const data = await response.json();
            addMessage(data.error ? `‚ùå Error: ${data.error}` : (data.response || 'No response'), false);
          } catch (error) {
            addMessage(`‚ùå Error: ${error.message}`, false);
          }
        };
        reader.onerror = () => addMessage(`‚ùå Error reading file: ${reader.error}`, false);
        reader.readAsText(file);
        fileInput.value = '';
      });

      // Helpers: parse and format currency/percent for Business Goals
      function parseCurrencyToNumber(value) {
        if (!value) return NaN;
        const n = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
        return isNaN(n) ? NaN : n;
      }

      function formatCurrency(n) {
        return `$${Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
      }

      function formatPercent(n) {
        return `${Number(n).toFixed(1)}%`;
      }

      function extractBusinessGoalsData(message) {
        const patterns = {
          revenue_target: /revenue\s*target\s*:\s*([^\n]+)/i,
          budget_total: /budget\s*total\s*:\s*([^\n]+)/i,
          marketing_spend: /marketing\s*spend\s*:\s*([^\n]+)/i,
          target_roi: /target\s*roi\s*:\s*([^\n%]+)%?/i,
          timeline_months: /timeline\s*:\s*([^\n]+)/i
        };
        const out = {};
        for (const [key, rx] of Object.entries(patterns)) {
          const m = message.match(rx);
          if (!m || !m[1]) continue;
          if (key === 'target_roi') {
            const v = parseFloat(String(m[1]).replace(/[^0-9.-]/g, ''));
            if (!isNaN(v)) out[key] = v;
          } else if (key === 'timeline_months') {
            const v = parseFloat(String(m[1]).replace(/[^0-9.-]/g, ''));
            if (!isNaN(v)) out[key] = v;
          } else {
            const v = parseCurrencyToNumber(m[1]);
            if (!isNaN(v)) out[key] = v;
          }
        }
        return out;
      }

      function summarizeBusinessGoals(bg) {
        if (!bg || !bg.revenue_target || !bg.budget_total) return null;
        const revenue = bg.revenue_target;
        const budget = bg.budget_total;
        const mkt = bg.marketing_spend || 0;
        const roiTarget = bg.target_roi || 0;
        const timeline = bg.timeline_months || null;
        const totalSpend = budget + mkt;
        const breakeven = totalSpend;
        const requiredReturn = totalSpend * (roiTarget / 100);
        const projectedNet = revenue - totalSpend;
        const roiAchieved = totalSpend > 0 ? (projectedNet / totalSpend) * 100 : 0;

        const lines = [
          '<strong>Business Goals Analysis</strong>',
          `Revenue Target: ${formatCurrency(revenue)}`,
          `Total Budget: ${formatCurrency(budget)} (Marketing: ${formatCurrency(mkt)})`,
          `Total Planned Spend: ${formatCurrency(totalSpend)}`,
          `Breakeven Revenue: ${formatCurrency(breakeven)}`,
          `Target ROI: ${formatPercent(roiTarget)}`,
          `Required Return to Hit ROI: ${formatCurrency(requiredReturn)}`,
          `Projected Net (Target - Spend): ${formatCurrency(projectedNet)} (${formatPercent(roiAchieved)})`,
          timeline ? `Timeline: ${timeline} months` : ''
        ].filter(Boolean);
        return lines.join('<br>');
      }

      window.sendMessage = async function() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Local analysis for Business Goals supports $ inputs
        if (/analyze\s+business\s+goals/i.test(message)) {
          const bg = extractBusinessGoalsData(message);
          const summary = summarizeBusinessGoals(bg);
          if (summary) addMessage(summary, false);
        }

        try {
          const response = await fetch('/chat/api/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': CSRF_TOKEN
            },
            body: `message=${encodeURIComponent(message)}&context=strategic_planning`
          });
          const data = await response.json();
          addMessage(data.error ? `‚ùå Error: ${data.error}` : (data.response || 'No response'), false);
        } catch (error) {
          addMessage(`‚ùå Error: ${error.message}`, false);
        }
      };

      function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = content;
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(time);
        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      window.clearChat = function() {
        messagesArea.innerHTML = `
          <div class="message assistant">
            <div class="message-bubble">Welcome to Strategic Planning! I can help you develop business strategies, create action plans, analyze market opportunities, and set achievable goals. What would you like to work on today?</div>
            <div class="message-time">Just now</div>
          </div>
        `;
      };

      window.swotAnalysis = () => { chatInput.value = 'Analysis type: SWOT\nPerform SWOT analysis. Strengths: loyal customer base, prime location; Weaknesses: high labor cost, limited seating; Opportunities: catering, online ordering; Threats: new competitors, rising food costs.'; chatInput.focus(); };
      window.businessGoals = () => { chatInput.value = 'Analysis type: Business Goals\nAnalyze business goals. Revenue target: $1,200,000. Budget total: $250,000. Marketing spend: $60,000. Target ROI: 20%. Timeline: 12 months.'; chatInput.focus(); };
      window.growthStrategy = () => { chatInput.value = 'Analysis type: Growth Strategy\nAnalyze growth strategy. Market size: $5,000,000. Market share: 3%. Competition level: 65%. Investment budget: $150,000. Target ROI: 18%.'; chatInput.focus(); };
      window.bestWay = () => { chatInput.value = 'Analysis type: Best Way\nGuide me with the best strategic planning sequence: define objectives, audit + SWOT, set KPIs, budget/resources, timeline/milestones, execute/track, review/improve. Use my uploaded CSVs if present.'; chatInput.focus(); };
    });
  </script>
</body>
</html>
