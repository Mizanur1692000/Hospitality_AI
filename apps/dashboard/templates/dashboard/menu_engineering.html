{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu Engineering - Restaurant Consulting</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'dashboard/css/modern-glass.css' %}">
  <style>
    /* Enhanced Menu Engineering Styles */
    .menu-matrix {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin: var(--spacing-xl) 0;
    }
    @media (max-width: 768px) { .menu-matrix { grid-template-columns: 1fr; } }
    
    .matrix-quadrant {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border: 1px solid rgba(102, 126, 234, 0.12);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      min-height: 220px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .matrix-quadrant::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, currentColor 0%, transparent 70%);
      opacity: 0.03;
      pointer-events: none;
    }

    .matrix-quadrant:hover {
      transform: translateY(-8px) scale(1.01);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.1),
        0 0 0 1px currentColor;
    }

    .matrix-quadrant::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }

    .matrix-quadrant.stars {
      color: #f59e0b;
    }
    .matrix-quadrant.stars::before { 
      background: linear-gradient(90deg, #fbbf24, #f59e0b, #d97706); 
    }
    .matrix-quadrant.stars:hover {
      box-shadow: 0 25px 50px rgba(245, 158, 11, 0.2), 0 0 0 1px rgba(245, 158, 11, 0.3);
    }

    .matrix-quadrant.plowhorses {
      color: #10b981;
    }
    .matrix-quadrant.plowhorses::before { 
      background: linear-gradient(90deg, #34d399, #10b981, #059669); 
    }
    .matrix-quadrant.plowhorses:hover {
      box-shadow: 0 25px 50px rgba(16, 185, 129, 0.2), 0 0 0 1px rgba(16, 185, 129, 0.3);
    }

    .matrix-quadrant.puzzles {
      color: #667eea;
    }
    .matrix-quadrant.puzzles::before { 
      background: linear-gradient(90deg, #818cf8, #667eea, #764ba2); 
    }
    .matrix-quadrant.puzzles:hover {
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.2), 0 0 0 1px rgba(102, 126, 234, 0.3);
    }

    .matrix-quadrant.dogs {
      color: #ef4444;
    }
    .matrix-quadrant.dogs::before { 
      background: linear-gradient(90deg, #f87171, #ef4444, #dc2626); 
    }
    .matrix-quadrant.dogs:hover {
      box-shadow: 0 25px 50px rgba(239, 68, 68, 0.2), 0 0 0 1px rgba(239, 68, 68, 0.3);
    }
    
    .quadrant-header { 
      display: flex; 
      align-items: center; 
      gap: var(--spacing-md); 
      margin-bottom: var(--spacing-lg);
    }

    .quadrant-icon { 
      width: 50px;
      height: 50px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: currentColor;
      color: white;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .quadrant-title { 
      font-size: 1.25rem; 
      font-weight: 700; 
      color: var(--text-primary);
    }

    .quadrant-subtitle { 
      font-size: 0.8rem; 
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .quadrant-desc { 
      font-size: 0.9rem; 
      color: var(--text-secondary); 
      margin-bottom: var(--spacing-lg);
      line-height: 1.6;
    }
    
    .menu-items-list { 
      list-style: none; 
      padding: 0; 
      margin: 0;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 250, 252, 0.8) 100%);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: var(--radius-md);
      margin-bottom: 0.625rem;
      font-size: 0.9rem;
      transition: all var(--transition-fast);
    }

    .menu-item:hover {
      background: white;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .menu-item-name { 
      font-weight: 600; 
      color: var(--text-primary);
    }

    .menu-item-stats { 
      display: flex; 
      gap: 1rem; 
      color: var(--text-secondary); 
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .analysis-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    @media (max-width: 992px) { .analysis-cards { grid-template-columns: 1fr; } }
    
    .analysis-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border: 1px solid rgba(102, 126, 234, 0.12);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .analysis-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }

    .analysis-card:hover::before {
      opacity: 1;
    }

    .analysis-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15);
    }

    .analysis-value { 
      font-size: 2.5rem; 
      font-weight: 800; 
      background: var(--primary-gradient); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text;
      position: relative;
      z-index: 1;
    }

    .analysis-label { 
      font-size: 0.9rem; 
      color: var(--text-secondary); 
      margin-top: 0.5rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Core Task Cards Enhancement */
    .core-task-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
      border: 1px solid rgba(102, 126, 234, 0.12);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      text-align: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .core-task-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .core-task-card:hover::before {
      transform: scaleX(1);
    }

    .core-task-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 
        0 25px 50px rgba(102, 126, 234, 0.2),
        0 0 0 1px rgba(102, 126, 234, 0.15);
    }

    .core-task-card:hover .task-icon {
      transform: scale(1.15) rotate(5deg);
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="animated-bg"></div>
  <div class="floating-orbs">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <!-- Header -->
  <header class="glass-header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-circle" aria-hidden="true">C</div>
        <div class="brand-text">
          <div class="company-name">Curated Restaurant Consulting</div>
          <div class="company-tagline">Driven by Data. Crafted for Excellence.</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="/dashboard/" class="back-button">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div class="glass-interface">
      <!-- Page Header -->
      <section class="page-header">
        <h1 class="page-title">Menu Engineering</h1>
        <p class="page-subtitle">Optimize your menu for maximum profitability with data-driven insights and strategic positioning</p>

        <!-- Core Tasks Grid -->
        <div class="core-tasks-grid">
          <!-- Menu Analysis -->
          <div class="core-task-card" onclick="analyzeMenu()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <rect x="4" y="4" width="32" height="32" rx="4" stroke="white" stroke-width="2"/>
                <path d="M10 16H30M10 24H30M10 32H20" stroke="white" stroke-width="2"/>
              </svg>
            </div>
            <div class="task-title">Menu Analysis</div>
            <div class="task-desc">Comprehensive menu performance review</div>
            <ul class="task-features">
              <li>Sales mix analysis</li>
              <li>Contribution margins</li>
              <li>Menu matrix mapping</li>
            </ul>
          </div>

          <!-- Pricing Strategy -->
          <div class="core-task-card" onclick="pricingStrategy()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <circle cx="20" cy="20" r="16" stroke="white" stroke-width="2"/>
                <path d="M20 10V30" stroke="white" stroke-width="2"/>
                <path d="M14 14C14 14 16 12 20 12C24 12 26 14 26 16C26 18 24 20 20 20C16 20 14 22 14 24C14 26 16 28 20 28C24 28 26 26 26 26" stroke="white" stroke-width="2"/>
              </svg>
            </div>
            <div class="task-title">Pricing Strategy</div>
            <div class="task-desc">Data-driven pricing optimization</div>
            <ul class="task-features">
              <li>Price elasticity</li>
              <li>Competitive analysis</li>
              <li>Profit maximization</li>
            </ul>
          </div>

          <!-- Item Optimization -->
          <div class="core-task-card" onclick="itemOptimization()">
            <div class="task-icon">
              <svg width="32" height="32" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <path d="M20 4L36 12V28L20 36L4 28V12L20 4Z" stroke="white" stroke-width="2"/>
                <path d="M20 4V36" stroke="white" stroke-width="2"/>
                <path d="M4 12L36 28" stroke="white" stroke-width="2"/>
                <path d="M36 12L4 28" stroke="white" stroke-width="2"/>
              </svg>
            </div>
            <div class="task-title">Item Optimization</div>
            <div class="task-desc">Improve underperforming items</div>
            <ul class="task-features">
              <li>Recipe costing</li>
              <li>Portion control</li>
              <li>Description optimization</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Analysis Summary -->
      <div class="analysis-cards">
        <div class="analysis-card">
          <div class="analysis-value" id="avg-margin">68%</div>
          <div class="analysis-label">Average Contribution Margin</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value" id="menu-score">B+</div>
          <div class="analysis-label">Menu Performance Score</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value" id="optimization">12</div>
          <div class="analysis-label">Items Need Optimization</div>
        </div>
      </div>

      <!-- Menu Matrix -->
      <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-md);">Menu Engineering Matrix</h2>
      <div class="menu-matrix">
        <!-- Stars -->
        <div class="matrix-quadrant stars">
          <div class="quadrant-header">
            <span class="quadrant-icon">‚≠ê</span>
            <div>
              <div class="quadrant-title">Stars</div>
              <div class="quadrant-subtitle">High Popularity ‚Ä¢ High Profit</div>
            </div>
          </div>
          <div class="quadrant-desc">Your best performers - maintain quality and visibility</div>
          <ul class="menu-items-list" id="stars-list">
            <li class="menu-item"><span class="menu-item-name">Grilled Salmon</span><span class="menu-item-stats"><span>CM: 72%</span><span>Pop: 85%</span></span></li>
            <li class="menu-item"><span class="menu-item-name">Ribeye Steak</span><span class="menu-item-stats"><span>CM: 68%</span><span>Pop: 82%</span></span></li>
          </ul>
        </div>

        <!-- Plowhorses -->
        <div class="matrix-quadrant plowhorses">
          <div class="quadrant-header">
            <span class="quadrant-icon">üê¥</span>
            <div>
              <div class="quadrant-title">Plowhorses</div>
              <div class="quadrant-subtitle">High Popularity ‚Ä¢ Low Profit</div>
            </div>
          </div>
          <div class="quadrant-desc">Increase prices or reduce costs carefully</div>
          <ul class="menu-items-list" id="plowhorses-list">
            <li class="menu-item"><span class="menu-item-name">Caesar Salad</span><span class="menu-item-stats"><span>CM: 42%</span><span>Pop: 78%</span></span></li>
            <li class="menu-item"><span class="menu-item-name">Pasta Primavera</span><span class="menu-item-stats"><span>CM: 38%</span><span>Pop: 75%</span></span></li>
          </ul>
        </div>

        <!-- Puzzles -->
        <div class="matrix-quadrant puzzles">
          <div class="quadrant-header">
            <span class="quadrant-icon">üß©</span>
            <div>
              <div class="quadrant-title">Puzzles</div>
              <div class="quadrant-subtitle">Low Popularity ‚Ä¢ High Profit</div>
            </div>
          </div>
          <div class="quadrant-desc">Increase visibility and marketing</div>
          <ul class="menu-items-list" id="puzzles-list">
            <li class="menu-item"><span class="menu-item-name">Duck Confit</span><span class="menu-item-stats"><span>CM: 74%</span><span>Pop: 25%</span></span></li>
            <li class="menu-item"><span class="menu-item-name">Lobster Risotto</span><span class="menu-item-stats"><span>CM: 70%</span><span>Pop: 22%</span></span></li>
          </ul>
        </div>

        <!-- Dogs -->
        <div class="matrix-quadrant dogs">
          <div class="quadrant-header">
            <span class="quadrant-icon">üêï</span>
            <div>
              <div class="quadrant-title">Dogs</div>
              <div class="quadrant-subtitle">Low Popularity ‚Ä¢ Low Profit</div>
            </div>
          </div>
          <div class="quadrant-desc">Consider removing or repositioning</div>
          <ul class="menu-items-list" id="dogs-list">
            <li class="menu-item"><span class="menu-item-name">Veggie Wrap</span><span class="menu-item-stats"><span>CM: 35%</span><span>Pop: 12%</span></span></li>
            <li class="menu-item"><span class="menu-item-name">Soup of Day</span><span class="menu-item-stats"><span>CM: 32%</span><span>Pop: 15%</span></span></li>
          </ul>
        </div>
      </div>

      <!-- Chat Section -->
      <section class="chat-section">
        <div class="chat-header">
          <h3 class="chat-title">Menu Engineering AI</h3>
          <button class="clear-chat" onclick="clearChat()">Clear Chat</button>
        </div>

        <div class="messages-area" id="messages-area">
          <div class="message assistant">
            <div class="message-bubble">Welcome to Menu Engineering! <strong>To analyze your menu, upload a CSV file</strong> or provide data:<br><br>
              <strong>üìÑ CSV File Format (Product Mix):</strong><br>
              ‚Ä¢ Required: product_name, quantity_sold, unit_price, cost<br>
              ‚Ä¢ Optional: category, revenue, profit, contribution_margin<br><br>
              <strong>üí∞ Menu Pricing Analysis:</strong><br>
              ‚Ä¢ Required: item_price, item_cost, competitor_price<br>
              ‚Ä¢ Optional: target_food_cost_percent<br><br>
              <strong>üé® Menu Design Analysis:</strong><br>
              ‚Ä¢ Requires product mix data first<br><br>
              <strong>Example CSV:</strong><br>
              product_name,quantity_sold,unit_price,cost<br>
              Margherita Pizza,94,21,6<br>
              Pepperoni Pizza,125,22,5</div>
            <div class="message-time">Just now</div>
          </div>
        </div>

        <div class="input-section">
          <div class="input-container">
            <textarea id="chat-input" class="chat-input" placeholder="Describe your menu or ask about optimization strategies..." rows="1"></textarea>
            <input type="file" id="file-input" accept=".csv,.xlsx" class="file-input"/>
            <button id="upload-button" class="upload-button" title="Upload menu data">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L16,16H13.5V19H10.5V16H8L12,12Z"/>
              </svg>
            </button>
            <button id="send-button" class="send-button" onclick="sendMessage()">
              <span>Analyze</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messagesArea = document.getElementById('messages-area');
      const chatInput = document.getElementById('chat-input');
      const fileInput = document.getElementById('file-input');
      const uploadButton = document.getElementById('upload-button');

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      }
      const CSRF_TOKEN = getCookie('csrftoken');

      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      uploadButton.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        addMessage(`üìÅ Uploading: ${file.name}`, true);
        
        const formData = new FormData();
        formData.append('task', 'product_mix');
        formData.append('file', file);

        try {
          const response = await fetch('/api/agent/', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: formData
          });
          const data = await response.json();
          console.log('Product Mix Response:', data);
          if (data.error) {
            addMessage(`‚ùå Error: ${data.error}`, false);
          } else if (data.status === 'error') {
            addMessage(`‚ùå ${data.message || 'Analysis error'}<br><strong>Help:</strong> ${data.help || ''}<br><strong>Your columns:</strong> ${data.your_columns?.join(', ') || 'N/A'}`, false);
          } else {
            addMessage(formatProductMixReport(data), false);
          }
        } catch (error) {
          addMessage(`‚ùå Error: ${error.message}`, false);
        }
        fileInput.value = '';
      });

      window.sendMessage = async function() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        chatInput.value = '';
        chatInput.style.height = 'auto';

        try {
          const response = await fetch('/chat/api/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': CSRF_TOKEN
            },
            body: `message=${encodeURIComponent(message)}&context=menu_engineering`
          });
          const data = await response.json();
          addMessage(data.error ? `‚ùå Error: ${data.error}` : (data.response || 'No response'), false);
        } catch (error) {
          addMessage(`‚ùå Error: ${error.message}`, false);
        }
      };

      function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = content;
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(time);
        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function formatProductMixReport(data) {
        if (!data) return 'No data received';
        
        // If business_report_html is available, use it
        if (data.business_report_html) {
          return data.business_report_html;
        }
        
        // Otherwise build custom report
        let html = `<div class="report"><div class="report__header"><h2>üçΩÔ∏è Menu Engineering Analysis</h2>`;
        html += `<div class="report__meta">Generated: ${new Date().toLocaleString()}</div>`;
        if (data.file_info) html += `<div class="report__meta">${data.file_info}</div>`;
        if (data.performance_rating) {
          const badgeClass = data.performance_rating.toLowerCase().replace(' ', '-');
          html += `<div class="badge badge--${badgeClass}">${data.performance_rating}</div>`;
        }
        html += `</div><div class="report__body">`;
        
        // Metrics Grid
        if (data.metrics) {
          html += '<h3 style="color: #667eea; margin-bottom: 1rem;">üìä Key Metrics</h3><div class="kpi-grid">';
          const m = data.metrics;
          if (m['Total Menu Items']) html += `<div class="kpi-card"><div class="kpi-value">${m['Total Menu Items']}</div><div class="kpi-label">Menu Items</div></div>`;
          if (m['Total Revenue']) html += `<div class="kpi-card"><div class="kpi-value">$${m['Total Revenue'].toLocaleString(undefined, {minimumFractionDigits: 2})}</div><div class="kpi-label">Total Revenue</div></div>`;
          if (m['Total Profit']) html += `<div class="kpi-card"><div class="kpi-value">$${m['Total Profit'].toLocaleString(undefined, {minimumFractionDigits: 2})}</div><div class="kpi-label">Total Profit</div></div>`;
          if (m['Average Contribution Margin']) html += `<div class="kpi-card"><div class="kpi-value">$${m['Average Contribution Margin'].toFixed(2)}</div><div class="kpi-label">Avg Margin</div></div>`;
          if (m['Average Food Cost Percent']) html += `<div class="kpi-card"><div class="kpi-value">${m['Average Food Cost Percent'].toFixed(1)}%</div><div class="kpi-label">Avg Food Cost</div></div>`;
          html += '</div>';
          
          // Menu Engineering Matrix
          html += '<h3 style="color: #667eea; margin: 1.5rem 0 1rem;">üéØ Menu Engineering Matrix</h3><div class="kpi-grid">';
          const matrixItems = [
            { label: 'Stars', value: m['Stars'] || 0, icon: '‚≠ê', desc: 'High Profit, High Sales', color: '#10b981' },
            { label: 'Plowhorses', value: m['Plowhorses'] || 0, icon: 'üê¥', desc: 'Low Profit, High Sales', color: '#f59e0b' },
            { label: 'Puzzles', value: m['Puzzles'] || 0, icon: 'üß©', desc: 'High Profit, Low Sales', color: '#3b82f6' },
            { label: 'Dogs', value: m['Dogs'] || 0, icon: 'üêï', desc: 'Low Profit, Low Sales', color: '#ef4444' }
          ];
          matrixItems.forEach(item => {
            html += `<div class="kpi-card" style="border-left: 4px solid ${item.color};">
              <div class="kpi-value">${item.icon} ${item.value}</div>
              <div class="kpi-label">${item.label}</div>
              <div style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">${item.desc}</div>
            </div>`;
          });
          html += '</div>';
        }
        
        // Recommendations
        if (data.recommendations && data.recommendations.length > 0) {
          html += '<h3 style="color: #667eea; margin: 1.5rem 0 1rem;">üí° Strategic Recommendations</h3>';
          html += '<div style="display: grid; gap: 0.75rem;">';
          data.recommendations.forEach((rec, idx) => {
            html += `<div style="background: rgba(102, 126, 234, 0.1); border-radius: 0.5rem; padding: 1rem; border-left: 4px solid #667eea;">
              <strong style="color: #667eea;">${idx + 1}.</strong> ${rec}
            </div>`;
          });
          html += '</div>';
        }
        
        // Top Items Table
        if (data.pmix_report && data.pmix_report.length > 0) {
          const topItems = data.pmix_report.slice(0, 10);
          html += '<h3 style="color: #667eea; margin: 1.5rem 0 1rem;">üèÜ Top ' + topItems.length + ' Items by Profit</h3>';
          html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
          html += '<thead><tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">';
          html += '<th style="padding: 0.75rem; text-align: left;">Item</th>';
          html += '<th style="padding: 0.75rem; text-align: right;">Qty Sold</th>';
          html += '<th style="padding: 0.75rem; text-align: right;">Price</th>';
          html += '<th style="padding: 0.75rem; text-align: right;">Cost</th>';
          html += '<th style="padding: 0.75rem; text-align: right;">Margin</th>';
          html += '<th style="padding: 0.75rem; text-align: right;">Total Profit</th>';
          html += '</tr></thead><tbody>';
          
          topItems.forEach((item, idx) => {
            const rowBg = idx % 2 === 0 ? 'rgba(102, 126, 234, 0.05)' : 'transparent';
            html += `<tr style="background: ${rowBg}; border-bottom: 1px solid rgba(102, 126, 234, 0.1);">`;
            html += `<td style="padding: 0.75rem; font-weight: 500;">${item.name}</td>`;
            html += `<td style="padding: 0.75rem; text-align: right;">${item.quantity_sold}</td>`;
            html += `<td style="padding: 0.75rem; text-align: right;">$${item.price?.toFixed(2)}</td>`;
            html += `<td style="padding: 0.75rem; text-align: right;">$${item.cost?.toFixed(2)}</td>`;
            html += `<td style="padding: 0.75rem; text-align: right;">$${item.contribution_margin?.toFixed(2)}</td>`;
            html += `<td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #10b981;">$${item.total_profit?.toFixed(2)}</td>`;
            html += '</tr>';
          });
          html += '</tbody></table></div>';
          
          if (data.pmix_report.length > 10) {
            html += `<p style="text-align: center; color: #888; margin-top: 0.5rem;">Showing top 10 of ${data.pmix_report.length} items</p>`;
          }
        }
        
        // Cost info
        if (data.cost_info) {
          html += `<p style="margin-top: 1rem; font-size: 0.875rem; color: #888;"><em>üìù Note: Costs ${data.cost_info}</em></p>`;
        }
        
        html += '</div></div>';
        return html;
      }

      window.clearChat = function() {
        messagesArea.innerHTML = `
          <div class="message assistant">
            <div class="message-bubble">Welcome to Menu Engineering! <strong>To get accurate analysis, please provide your data</strong>:<br><br>
              <strong>üìä Menu Engineering Analysis:</strong><br>
              ‚Ä¢ Required: item_name, price, cost, quantity_sold<br>
              ‚Ä¢ Optional: category, food_cost_percent, popularity_rank<br><br>
              Upload a CSV file or describe your menu items. Click the quick action buttons below for examples.</div>
            <div class="message-time">Just now</div>
          </div>
        `;
      };

      window.analyzeMenu = () => { chatInput.value = 'Analyze my product mix. Total sales: $50,000. Item sales: $5,000. Item cost: $1,500. Item profit: $3,500.'; chatInput.focus(); };
      window.pricingStrategy = () => { chatInput.value = 'Analyze menu pricing. Item price: $18. Item cost: $5.50. Competitor price: $16. Target food cost: 32%.'; chatInput.focus(); };
      window.itemOptimization = () => { chatInput.value = 'Analyze menu design. Menu items: 25. High profit items: 8. Sales distribution: appetizers 40%, entrees 60%. Visual hierarchy: top-right placement.'; chatInput.focus(); };
    });
  </script>
</body>
</html>
